var setsidebartype = function () {
  var width =
    window.innerWidth > 0 ? window.innerWidth : this.screen.width;
  if (width < 1199) {
    $("#main-wrapper").attr("data-sidebartype", "mini-sidebar");
    $("#main-wrapper").addClass("mini-sidebar");
  } else {
    $("#main-wrapper").attr("data-sidebartype", "full");
    $("#main-wrapper").removeClass("mini-sidebar");
  }
};
$(window).ready(setsidebartype);
$(window).on("resize", setsidebartype);

$(".sidebartoggler").on("click", function () {
  $("#main-wrapper").toggleClass("mini-sidebar");
  if ($("#main-wrapper").hasClass("mini-sidebar")) {
    $(".sidebartoggler").prop("checked", !0);
    $("#main-wrapper").attr("data-sidebartype", "mini-sidebar");
  } else {
    $(".sidebartoggler").prop("checked", !1);
    $("#main-wrapper").attr("data-sidebartype", "full");
  }
});
$(".sidebartoggler").on("click", function () {
  $("#main-wrapper").toggleClass("show-sidebar");
});
$("#news").hover(
  function () {
    $("#tooltip").fadeIn();
  },
  function () {
    $("#tooltip").fadeOut();
  });
$('[data-bs-toggle="modal"]').click(function () {
  if ($(this).data('bs-target') === "#myModal") {
    var id = $(this).find('td:eq(0)').text();
    var fecha = $(this).find('td:eq(1)').text();
    var cliente = $(this).find('td:eq(2)').text();
    var estado = $(this).find('td:eq(4)').text()?.trim();
    var transcurrido = $(this).find('td:eq(5)').text();
    var productoId = $(this).data('producto-id');
    var productoImagen = $(this).data('producto-image');
    var productoPrecio = $(this).data('producto-precio');
    var productoNombre = $(this).data('producto-nombre');
    var clientedoc = $(this).data('cliente-numdoc');
    var clienteId = $(this).data('cliente-id');
    var badgeColor, disabled = '', alert = '', buttons = '';

    switch (estado) {
      case 'Pendiente':
        badgeColor = 'bg-warning';
        buttons = '<input type="submit" class="btn btn-primary rounded-3" id="confirmar-pedido" value="Confirmar pedido">'
          + '<button class="btn btn-danger rounded-3" id="cancelar-pedido">Cancelar pedido</button>';
        break;
      case 'Confirmado':
        badgeColor = 'bg-success';
        disabled = 'disabled';
        alert = '<div id="pedido-confirmado" class="alert alert-success">El pedido está confirmado</div>';
        break;
      case 'Cancelado':
        badgeColor = 'bg-danger';
        disabled = 'disabled';
        alert = '<div id="pedido-cancelado" class="alert alert-danger">El pedido está cancelado</div>';
        break;
    }
    var igv = productoPrecio * 0.18;
    var total = productoPrecio - igv;

    $('#datos-pedido').html(
      '<div class="row g-3 px-3 align-items-center">'
      + '<div class="col">'
      + '<h5 class="fw-semibold mb-4">Id del pedido: <span class="fw-normal">' + id + '</span></h5>'
      + '<h6 class="fw-semibold mb-2">Fecha: <span class="fw-normal">' + fecha + '</span></h6>'
      + '<p class="fw-semibold mb-2">Estado: <span class="fw-semibold rounded-3 badge ' + badgeColor + '">' + estado + '</span></p>'
      + '<p class="fw-semibold mb-4">Transcurrido: <span class="fw-semibold text-primary">' + transcurrido + '</span></p>'
      + '<div class="card" style="border-radius: 1rem;">'
      + '<div class="card-body">'
      + '<h6 class="fw-semibold">Descripción del producto</h6>'
      + '<img class="mb-4" src="data:image/png;base64,' + productoImagen + '" width="300px">'
      + '<p class="fw-semibold">' + productoNombre + '</p>'
      + '<h5 class="fw-semibold text-end"> S/.' + productoPrecio + '</h5>'
      + '</div></div></div>'
      + '<div class="col-lg-5">'
      + alert
      + '<h5 class="fw-semibold mb-4">Resumen</h5>'
      + '<form action="../../../../app/controlador/admin/confirmar_pedido.php" method="post">'
      + '<div class="form-container p-2">'
      + '<input type="hidden" name="id-cliente" id="id-cliente" value="' + clienteId + '">'
      + '<h6 class="fw-semibold mb-3">Cliente: <span class="fw-normal">' + clientedoc + ' - ' + cliente + '</span></h6>'
      + '<label class="mb-2" for="tipo-comprobante">Tipo comprobante:</label>'
      + '<select class="form-select mb-3" id="tipo-comprobante" name="tipo-comprobante"' + disabled + ' required>'
      + '<option value="1">Boleta</option>'
      + '<option value="2">Factura</option>'
      + '</select>'
      + '<div class="form-group mb-4">'
      + '<label class="mb-2" for="pedido-vendedor">Vendedor:</label>'
      + '<input type="number" class="form-control" placeholder="Ingrese Id del vendedor" id="pedido-vendedor" name="pedido-vendedor" maxlength="6"' + disabled + ' required>'
      + '<div id="mensaje-error" class="text-danger"></div>'
      + '</div>'
      + '<label class="mb-2" for="pedido-subtotal">Subtotal:</label>'
      + '<div class="input-group mb-3">'
      + '<span class="input-group-text" id="basic-addon1">S/.</span>'
      + '<input type="number" class="form-control" id="pedido-subtotal" name="pedido-subtotal" value="' + productoPrecio + '"' + disabled + ' required>'
      + '</div>'
      + '<div class="form-group mb-4">'
      + '<label class="mb-2" for="pedido-descuento">Descuento:</label>'
      + '<input type="number" class="form-control" id="pedido-descuento" name="pedido-descuento"' + disabled + ' maxlength="6">'
      + '<div id="mensaje-error" class="text-danger"></div>'
      + '</div>'
      + '<h5 class="fw-semibold text-end mb-4 mt-4" id="igv-label">IGV: <span class="fw-normal">S/.' + Math.round(igv * 100) / 100 + '</span></h5>'
      + '<h5 class="fw-semibold text-end mb-4 mt-4" id="total-label">Total: <span class="fw-normal">S/.' + Math.round(total * 100) / 100 + '</span></h5>'
      + '<div class="d-grid gap-2">'
      + buttons
      + '</div></form></div></div></div>'
    );

    $('#pedido-descuento').on('input', function () {
      actualizarTotal();
    });

    $('#pedido-subtotal').on('input', function () {
      actualizarTotal();
    });

    function actualizarTotal() {
      var descuento = parseFloat($('#pedido-descuento').val()) || 0;
      var subtotal = parseFloat($('#pedido-subtotal').val()) || 0;

      if (descuento > total) {
        $('#mensaje-error').text('Monto incorrecto').show();
        $('#total-label span').text(total);
      } else {
        $('#mensaje-error').text('').hide();
        igv = (subtotal - descuento) * 0.18;
        total = subtotal - descuento - igv;
        $('#igv-label span').text(Math.round(igv * 100) / 100);
        $('#pedido-igv').val(Math.round(igv * 100) / 10);
        $('#total-label span').text(Math.round(total * 100) / 100);
        $('#pedido-total').val(Math.round(total * 100) / 100);
      }
    }

    $('#cancelar-pedido').on('click', function (e) {
      e.preventDefault();
      $.ajax({
        type: 'POST',
        url: '../../../../app/controlador/admin/cancelar_pedido.php',
        data: { pedidoId: id, nuevoEstado: 'Cancelado' },
        success: function () {
          $('#myModal').modal('hide');
          console.log('Successssss');
          window.location.reload();
        },
        error: function (error) {
          console.error(error);
        }
      });
    });

    $('#confirmar-pedido').on('click', function (e) {
      e.preventDefault();
      var data = {
        pedidoId: id, nuevoEstado: 'Confirmado',
        tipo_comprobante: $('#tipo-comprobante').val()?.trim(),
        id_vendedor: $('#pedido-vendedor').val()?.trim(),
        id_cliente: clienteId,
        id_producto: productoId,
        subtotal: $('#pedido-subtotal').val()?.trim(),
        descuento: $('#pedido-descuento').val()?.trim(),
        igv: igv || '0',
        total: total || '0'
      }
      $.ajax({
        type: 'POST',
        url: '../../../../app/controlador/admin/confirmar_pedido.php',
        data: data,
        success: function () {
          $('#myModal').modal('hide');
          //window.location.replace('../../../../app/vista/admin/sales-system/ventas.php')
        },
        error: function (error) {
          console.error(error);
        }
      });
    });
    $('#myModal').modal('show');

  } else if ($(this).data('bs-target') === "#modalVenta") {
    var id = $(this).find('td:eq(0)').text();
    var tipo_comprobante = $(this).data('tipo-comprobante') == "1" ? "Boleta" : "Factura";
    var clientedoc = $(this).data('cliente-doc');
    var fecha = $(this).find('td:eq(1)').text();
    var vendedorId = $(this).find('td:eq(2)').text();
    var vendedor = $(this).data('vendedor-nom');
    var productoId = $(this).find('td:eq(3)').text();
    var producto = $(this).data('producto-nom');
    var clienteNombre = $(this).data('cliente-nom');
    var subtotal = $(this).find('td:eq(5)').text();
    var descuento = $(this).find('td:eq(6)').text();
    var igv = $(this).find('td:eq(7)').text();
    var total = $(this).find('td:eq(8)').text();

    console.log(id, fecha)

    var htmlContent = `
  <form id="formulario-detalle-venta" class="p-2" action="../../../../app/controlador/admin/generar_pdf.php" target="_blank" method="post">
  <input type="hidden" name="id" value="${id}">
  <input type="hidden" name="fecha" value="${fecha}">
  <input type="hidden" name="tipo_comprobante" value="${tipo_comprobante}">
  <input type="hidden" name="clientedoc" value="${clientedoc}">
  <input type="hidden" name="clienteNombre" value="${clienteNombre}">
  <input type="hidden" name="vendedorId" value="${vendedorId}">
  <input type="hidden" name="vendedorNombre" value="${vendedor}">
  <input type="hidden" name="productoId" value="${productoId}">
  <input type="hidden" name="productoNombre" value="${producto}">
  <input type="hidden" name="subtotal" value="${subtotal}">
  <input type="hidden" name="descuento" value="${descuento}">
  <input type="hidden" name="igv" value="${igv}">
  <input type="hidden" name="total" value="${total}">
    <div class="row">
    <h5 class="fw-semibold mb-4">ID de Venta: ${id}</h5>
      <div class="col">
        <h5 class="fw-semibold">Fecha:</h5>
        <p class="fw-normal">${fecha}</p>
      </div>
      <div class="col">
        <h5 class="fw-semibold">Tipo de Comprobante:</h5>
        <p class="fw-normal">${tipo_comprobante}</p>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <h5 class="fw-semibold">Vendedor:</h5>
        <p class="fw-normal">${vendedorId} - ${vendedor}</p>
      </div>
      <div class="col">
        <h5 class="fw-semibold">Cliente:</h5>
        <p class="fw-normal">${clientedoc} - ${clienteNombre}</p>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <h5 class="fw-semibold">Producto:</h5>
        <p class="fw-normal">${productoId} - ${producto}</p>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <h5 class="fw-semibold">Subtotal:</h5>
        <p class="fw-normal">S/. ${subtotal}</p>
      </div>
      <div class="col">
        <h5 class="fw-semibold">Descuento:</h5>
        <p class="fw-normal">S/. ${descuento}</p>
      </div>
      <div class="col">
        <h5 class="fw-semibold">IGV:</h5>
        <p class="fw-normal">S/. ${igv}</p>
      </div>
      <div class="col">
        <h5 class="fw-semibold">Total Venta:</h5>
        <p class="fw-normal">S/. ${total}</p>
      </div>
    </div>
    <div class="d-grid gap-2 mt-4">
      <button class="btn btn-warning" id="btn-enviar-correo">Enviar por correo electrónico</button>
      <button class="btn btn-primary" id="btn-generar-pdf">Imprimir voucher</button>
    </div>
  </form>`;

    $('#datos-venta').html(htmlContent);
    $('#modalVenta').modal('show');
  } else if ($(this).data('bs-target') === "#modalCliente") {

  }
});